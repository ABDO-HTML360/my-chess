<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لعبة شطرنج عبد الرحمن محمد فتحي</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
  <style>
    body { font-family: Tahoma, sans-serif; text-align: center; }
    #board { width: 400px; margin: 20px auto; }
    #messages { margin-top: 20px; text-align: left; width: 400px; margin-left: auto; margin-right: auto; }
    input, button { margin: 5px; padding: 8px; }
  </style>
</head>
<body>
  <h1>لعبة شطرنج عبد الرحمن  محمد فتحي </h1>

  <div>
    <input id="playerName" placeholder="اكتب اسمك هنا">
    <button onclick="joinGame()">دخول</button>
  </div>

  <div>
    <input id="friendName" placeholder="اسم صديقك">
    <button onclick="inviteFriend()">إرسال دعوة</button>
  </div>

  <div id="board"></div>

  <div>
    <button onclick="resetGame()">إعادة اللعبة</button>
    <button onclick="undoMove()">رجوع خطوة</button>
  </div>

  <div id="messages"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
  <script>
    var socket = io();
    var board = null;
    var game = new Chess();
    var playerName = "";

    function joinGame() {
      playerName = document.getElementById("playerName").value;
      if (playerName.trim() === "") {
        alert("من فضلك اكتب اسمك");
        return;
      }
      socket.emit('join', playerName);
      document.getElementById("messages").innerHTML += `<p>انت دخلت باسم: ${playerName}</p>`;
    }

    function inviteFriend() {
      let friendName = document.getElementById("friendName").value;
      if (friendName.trim() === "") {
        alert("اكتب اسم صديقك أولاً");
        return;
      }
      socket.emit("invite", friendName);
      document.getElementById("messages").innerHTML += `<p>تم إرسال دعوة إلى ${friendName}</p>`;
    }

    socket.on("receiveInvite", (data) => {
      if (data.to === playerName) {
        let accept = confirm(`${data.from} دعاك للعبة، هل توافق؟`);
        socket.emit("inviteResponse", { from: data.from, to: playerName, accept: accept });
      }
    });

    socket.on("inviteResult", (data) => {
      if (data.accept) {
        document.getElementById("messages").innerHTML += `<p>${data.to} وافق على الدعوة!</p>`;
      } else {
        document.getElementById("messages").innerHTML += `<p>${data.to} رفض الدعوة.</p>`;
      }
    });

    function onDragStart(source, piece, position, orientation) {
      if (game.game_over()) return false;
      if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
          (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
        return false;
      }
    }

    function onDrop(source, target) {
      var move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';
      board.position(game.fen());
      socket.emit('move', { from: source, to: target });
    }

    function resetGame() {
      game.reset();
      board.start();
      socket.emit('reset');
    }

    function undoMove() {
      game.undo();
      board.position(game.fen());
      socket.emit('undo');
    }

    board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDragStart: onDragStart,
      onDrop: onDrop
    });

    socket.on('message', (msg) => {
      document.getElementById("messages").innerHTML += `<p>${msg}</p>`;
    });

    socket.on('move', (data) => {
      game.move({ from: data.move.from, to: data.move.to, promotion: 'q' });
      board.position(data.fen);
      document.getElementById("messages").innerHTML += `<p>حركة من ${data.player}</p>`;
    });

    socket.on('reset', (data) => {
      game.reset();
      board.position(data.fen);
      document.getElementById("messages").innerHTML += `<p>تمت إعادة اللعبة</p>`;
    });

    socket.on('undo', (data) => {
      game.undo();
      board.position(data.fen);
      document.getElementById("messages").innerHTML += `<p>تم الرجوع خطوة للخلف</p>`;
    });
  </script>
</body>
</html>
