<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لعبة شطرنج عبد الرحمن محمد فتحي</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Tahoma, Arial; background: #f0f0f0; text-align: center; margin: 0; padding: 10px; }
    h1 { font-size: 20px; margin-bottom: 10px; }
    #board { width: 95vw; max-width: 400px; margin: 10px auto; }
    input { padding: 10px; font-size: 16px; width: 80%; max-width: 300px; margin: 10px auto; display: block; border: 1px solid #ccc; border-radius: 5px; }
    .btn { padding: 12px 20px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 45%; }
    .btn:hover { background: #45a049; }
    #messages { margin-top: 15px; background: #fff; padding: 10px; border: 1px solid #ccc; width: 95vw; max-width: 400px; margin-left: auto; margin-right: auto; text-align: left; font-size: 14px; overflow-y: auto; max-height: 150px; }
  </style>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"/>
</head>
<body>
  <h1>لعبة شطرنج عبد الرحمن محمد فتحي</h1>
  <input type="text" id="playerName" placeholder="اكتب اسمك هنا">
  <button class="btn" onclick="joinGame()">دخول</button>
  <input type="text" id="friendName" placeholder="اكتب اسم صديقك">
  <button class="btn" onclick="inviteFriend()">إرسال دعوة</button>
  <div id="board"></div>
  <button class="btn" onclick="resetGame()">إعادة</button>
  <button class="btn" onclick="undoMove()">رجوع</button>
  <div id="messages"></div>

  <script>
    var socket = io();
    var board = null;
    var game = new Chess();
    var playerName = "";

    function joinGame() {
      playerName = document.getElementById("playerName").value;
      if (playerName.trim() === "") {
        alert("من فضلك اكتب اسمك");
        return;
      }
      socket.emit('join', playerName);
      document.getElementById("messages").innerHTML += `<p>انت دخلت باسم: ${playerName}</p>`;
    }

    function inviteFriend() {
      let friendName = document.getElementById("friendName").value;
      if (friendName.trim() === "") {
        alert("اكتب اسم صديقك أولاً");
        return;
      }
      socket.emit("invite", friendName);
      document.getElementById("messages").innerHTML += `<p>تم إرسال دعوة إلى ${friendName}</p>`;
    }

    socket.on("receiveInvite", (data) => {
      if (data.to === playerName) {
        let accept = confirm(`${data.from} دعاك للعبة، هل توافق؟`);
        socket.emit("inviteResponse", { from: data.from, to: playerName, accept: accept });
      }
    });

    socket.on("inviteResult", (data) => {
      if (data.accept) {
        document.getElementById("messages").innerHTML += `<p>${data.to} وافق على الدعوة!</p>`;
      } else {
        document.getElementById("messages").innerHTML += `<p>${data.to} رفض الدعوة.</p>`;
      }
    });

    function onDragStart (source, piece, position, orientation) {
      if (game.game_over()) return false;
      if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
          (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
        return false;
      }
    }

    function onDrop (source, target) {
      var move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';
      board.position(game.fen());
      socket.emit('move', { from: source, to: target });
    }

    function resetGame() {
      game.reset();
      board.start();
    }

    function undoMove() {
      game.undo();
      board.position(game.fen());
    }

    board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDragStart: onDragStart,
      onDrop: onDrop
    });

    socket.on('message', (msg) => {
      document.getElementById("messages").innerHTML += `<p>${msg}</p>`;
    });

    socket.on('move', (data) => {
      game.move({ from: data.move.from, to: data.move.to, promotion: 'q' });
      board.position(game.fen());
      document.getElementById("messages").innerHTML += `<p>حركة من ${data.player}</p>`;
    });
  </script>
</body>
</html>
